<!--
  `admin-gc-workflows`

  Displays a button allowing for deleting orphaned workflows.

  User must be an administrator or an authorized user.

  There is no properties to set, usage is simple after importing the element:
  <admin-gc-workflows></admin-gc-workflows>

  The width of the button can be set in the :host style via the --admin-button-width variable
-->
<dom-module id="admin-gc-workflows">
  <template>
    <style include="iron-flex iron-flex-alignment nuxeo-styles">

    #gcOrphanedWorkflowsButton {
      width:  var(--admin-button-width);
    }

    nuxeo-dialog {
      max-width: 50%;
    }

    .scrollableTable {
      height: 300px;
      overflow: auto;
      border-style: solid;
      border-width: 1px;
      border-color: grey;
      padding: 5px;
    }
    </style>

    <iron-ajax id="callAjax"
               url="/nuxeo/api/v1/management/workflows/orphaned"
               method="DELETE"
               on-response="_getManagementResponse"
               on-error="_ajaxCallFailure">
    </iron-ajax>

    <paper-button id="gcOrphanedWorkflowsButton"
                  raised noink
                  on-tap="_gcOrphanedWorkflows">
      Garbage Collect Orphaned Workflows
    </paper-button>

  </template>

  <script>
    Polymer({
      is: 'admin-gc-workflows',
      behaviors: [Nuxeo.LayoutBehavior],
      properties: {
        pageProviders: Array
      },

      // Button is clicked
      _gcOrphanedWorkflows: function() {
        if(confirm("Garbage COllect the orphan worlflows?")) {
          this.$.callAjax.generateRequest();
        }
        
      },

      // Callback from iron-ajax with success
      _getManagementResponse: function(evt, req) {
        let looksOk = false;
        if(evt && evt.detail && evt.detail.response) {
          if(evt.detail.status == 200) {
            if(evt.detail.response["entity-type"] === "bulkStatus") {
              looksOk = evt.detail.response.state === "SCHEDULED";
            }
          }
        }
        if(looksOk) {
          alert("Garbage collection of orphaned workflows succesfully started.");
        } else {
          alert("return status is unclear: " + evt.detail.status);
        }
      },

      // Ajax call failed
      // Impossible to get the result dialog displayed, nor the page
      // correctly refreshed. I believe the error occuring breaks
      // and maybe bubbles something.
      // => Simple alert, and then reload()
      _ajaxCallFailure: function(evt, req) {
        alert("An error occured when running <Get Nuxeo Distribution>:\n\n" + evt.detail.error.stack);
        this._cleanUpResultDialogValues();
        location.reload();
      }
    });
  </script>
</dom-module>
