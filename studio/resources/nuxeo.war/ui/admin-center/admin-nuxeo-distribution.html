<!--
  `admin-nuxeo-distribution`

  Displays a button allowing for fetching the current distribution info
  (Nuxeo verison, installed plugins).

  User must be an administrator or an authorized user.

  There is no properties to set, usage is simple after importing the element:
  <admin-nuxeo-distribution></admin-nuxeo-distribution>
-->
<dom-module id="admin-nuxeo-distribution">
  <template>
    <style include="iron-flex iron-flex-alignment nuxeo-styles">

    nuxeo-dialog {
      max-width: 700px;
    }

    /* Actually, for whatever reason, can't set this style on a div...
       => using inline style */
    .label: {
      color:  black;
      font-weight: bold;
    }

    .scrollableTable {
      height: 300px;
      overflow: auto;
      border-style: solid;
      border-width: 1px;
      border-color: grey;
      padding: 5px;
    }
    </style>

    <iron-ajax id="callAjax"
               url="/nuxeo/api/v1/management/distribution"
               method="GET"
               on-response="_getDistributionResponse"
               on-error="_ajaxCallFailure">
    </iron-ajax>

    <paper-button id="getDistributionButton"
                  raised noink
                  on-tap="_getDistribution">
      Nuxeo Distribution Info
    </paper-button>

    <!-- Display the result -->
    <nuxeo-dialog id="resultDialog" with-backdrop>
      <h3>Nuxeo Distribution</h3>

      <nuxeo-card header="Result for Nuxeo Distribution">
        <div role="widget">
          <div style="font-weight: bold">Nuxeo Application</div>
          <div>[[distributionResult.applicationName]] [[distributionResult.applicationVersion]]</div>
        </div>

        <div role="widget">
          <div style="font-weight: bold">Nuxeo Distribution</div>
          <div>[[distributionResult.distributionName]] [[distributionResult.distributionVersion]] (date: [[distributionResult.distributionDate]])</div>
        </div>

        <div role="widget">
          <div style="font-weight: bold">Bundles</div>
          <div class="scrollableTable">
            <table style="height: 300px">
                <template is="dom-repeat" items="[[distributionResult.bundles]]">
                  <tr>
                    <td width="60%">[[item.name]]</td>
                    <td>[[item.version]]</td>
                  </tr>
                </template>
            </table>
          </div>
        </div>
      </nuxeo-card>

      <div class="buttons" style="float: right;">
        <paper-button id="resultOkButton" dialog-dismiss class="primary" on-click="_resultDialogClosed">Ok</paper-button>
      </div>
    </nuxeo-dialog>

  </template>

  <script>
    Polymer({
      is: 'admin-nuxeo-distribution',
      behaviors: [Nuxeo.LayoutBehavior],
      properties: {
        distributionResult: Object
      },

      // Button is clicked
      _getDistribution: function() {
        // Reset values
        this._cleanUpResultDialogValues();

        // Call Nuxeo
        this.$.callAjax.generateRequest();
      },

      // Callback from iron-ajax with success
      _getDistributionResponse: function(evt, req) {

        this._cleanUpResultDialogValues();
        this.distributionResult = evt.detail.response;
        this.$.resultDialog.toggle();
      },

      // Ajax call failed
      // Impossible to get the result dialog displayed, nor the page
      // correctly refreshed. I believe the error occuring breaks
      // and maybe bubbles something.
      // => Simple alert, and then reload()
      _ajaxCallFailure: function(evt, req) {
        alert("An error occured when running <Get Nuxeo Distribution>:\n\n" + evt.detail.error.stack);
        this._cleanUpResultDialogValues();
        location.reload();
      },

      // Result dialogs handling
      _cleanUpResultDialogValues: function() {
        this.distributionResult = {};
      },

      _resultDialogClosed: function() {
        this._cleanUpResultDialogValues();
      }
    });
  </script>
</dom-module>
