<!--
  `admin-nuxeo-probes`

  Displays a button allowing for fetching info on all probes

  User must be an administrator or an authorized user.

  There is no properties to set, usage is simple after importing the element:
  <admin-nuxeo-probes></admin-nuxeo-probes>
-->
<dom-module id="admin-nuxeo-probes">
  <template>
    <style include="iron-flex iron-flex-alignment nuxeo-styles">

    nuxeo-dialog {
      max-width: 700px;
    }

    /* Actually, for whatever reason, can't set this style on a div...
       => using inline style */
    .label: {
      color:  black;
      font-weight: bold;
    }

    .columnHeader {
      font-weight: bold;
    }

    .scrollableTable {
      height: 300px;
      overflow: auto;
      border-style: solid;
      border-width: 1px;
      border-color: grey;
      padding: 5px;
    }
    </style>

    <iron-ajax id="callAjax"
               url="/nuxeo/api/v1/management/probes"
               method="GET"
               on-response="_getProbesResponse"
               on-error="_ajaxCallFailure">
    </iron-ajax>

    <paper-button id="getProbesButton"
                  raised noink
                  on-tap="_getProbes">
      Probes
    </paper-button>

    <!-- Display the result -->
    <nuxeo-dialog id="resultDialog" with-backdrop>
      <h3>Probes</h3>

      <nuxeo-card>

        <div role="widget">
          <div class="scrollableTable">
            <table style="height: 300px;border-spacing: 10px;">
                  <tr>
                    <td class="columnHeader">Probe</td>
                    <td class="columnHeader">Never Executed</td>
                    <td class="columnHeader">Success</td>
                    <td class="columnHeader">Info</td>
                  </tr>
                <template is="dom-repeat" items="[[probesResult]]">
                  <tr>
                    <td>[[item.name]]</td>
                    <td style="text-align: center;">[[item.status.neverExecuted]]</td>
                    <td style="text-align: center;">[[_formatProbeSucces(item.status.neverExecuted, item.status.success)]]</td>
                    <td>[[item.status.infos.info]]</td>
                  </tr>
                </template>
            </table>
          </div>
        </div>
      </nuxeo-card>

      <div class="buttons" style="float: right;">
        <paper-button id="resultOkButton" dialog-dismiss class="primary" on-click="_resultDialogClosed">Ok</paper-button>
      </div>
    </nuxeo-dialog>

  </template>

  <script>
    Polymer({
      is: 'admin-nuxeo-probes',
      behaviors: [Nuxeo.LayoutBehavior],
      properties: {
        probesResult: Object
      },

      // Button is clicked
      _getProbes: function() {
        // Reset values
        this._cleanUpResultDialogValues();

        // Call Nuxeo
        this.$.callAjax.generateRequest();
      },

      // Callback from iron-ajax with success
      _getProbesResponse: function(evt, req) {
        this.probesResult = evt.detail.response.entries;
        this.probesResult.sort((a, b) => a.name.localeCompare(b.name));
        this.$.resultDialog.toggle();
      },

      // Ajax call failed
      // Impossible to get the result dialog displayed, nor the page
      // correctly refreshed. I believe the error occuring breaks
      // and maybe bubbles something.
      // => Simple alert, and then reload()
      _ajaxCallFailure: function(evt, req) {
        alert("An error occured when running <Get Probes>:\n\n" + evt.detail.error.stack);
        this._cleanUpResultDialogValues();
        location.reload();
      },

      // Result dialogs handling
      _cleanUpResultDialogValues: function() {
        this.distributionResult = {};
      },

      _resultDialogClosed: function() {
        this._cleanUpResultDialogValues();
      },

      _formatProbeSucces: function(neverExecuted, result) {
        if(neverExecuted) {
          return "-";
        } else {
          return result;
        }
      }
    });
  </script>
</dom-module>
