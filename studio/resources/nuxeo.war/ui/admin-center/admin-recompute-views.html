<!--
  `admin-recompute-views`

  Displays a button allowing for recomputing picture:views fields.

  User must be an administrator or an authorized user.

  There is no properties to set, usage is simple after importing the element:
  <admin-recompute-views></admin-recompute-views>

  The width of the button can be set in the :host style via the --admin-button-width variable
-->
<link rel="import" href="nuxeo-admin-confirm.html">
<dom-module id="admin-recompute-views">
  <template>
    <style include="iron-flex iron-flex-alignment nuxeo-styles">
    #recomputeViewsButton {
      width:  var(--admin-button-width);
    }
    </style>

    <nuxeo-operation id="recomputeViewsOp"
                     op="Picture.RecomputeViews"></nuxeo-operation>

    <paper-button id="recomputeViewsButton"
                  raised noink
                  on-tap="_recomputeViews">
      Recompute <code style="margin-left: 10px">picture:views</code>
    </paper-button>

    <nuxeo-admin-confirm id="adminConfirmDialog"
                         confirm-prompt="Recompute picture:views fields?"
                         confirm-info="Enter the NXQL query to use:"
                         prompt="SELECT * FROM Document WHERE ecm:mixinType = 'Picture' AND picture:views/*/title IS NULL"
                         is-prompt
                         confirm-ok-label="Recompute"></nuxeo-admin-confirm>

    <!-- Display the result -->
    <nuxeo-dialog id="resultDialog" with-backdrop>
      <h3>Recompute picture:views</h3>

      <p>
        The views are being recomputed.<br/>
        It is an asynchronous process: Please, monitor the log to check once it is done.
      </p>

      <div class="buttons" style="float: right;">
        <paper-button id="resultOkButton" dialog-dismiss class="primary">Ok</paper-button>
      </div>
    </nuxeo-dialog>

  </template>

  <script>
    Polymer({
      is: 'admin-recompute-views',
      behaviors: [Nuxeo.LayoutBehavior],
      properties: {
      },

      // Listeners to get the action on the nuxeo-admin-confirm
      listeners: {
        "adminDialogOk": '_confirmDialogOk',
        "adminDialogCancel": '_confirmDialogCancel'
      },

      // Button is clicked
      _recomputeViews: function() {
        this.$.adminConfirmDialog.toggle();
      },

      // nuxeo-admin-confirm dialog OK button clicked
      _confirmDialogOk: function(evt, result) {
        if(!confirm("Compute picture:views for this query?\n\n" + result.prompt)) {
          return;
        }

        let op = this.$.recomputeViewsOp;
        op.params = {
          "query": result.prompt
        };

        op.execute()
          .then(function(result) {
            this.$.resultDialog.toggle();
          }.bind(this))
          .catch(function(error) {
            alert("An error occured when running <Recompute picture:views>:\n\n" + error);
          }.bind(this));
      },

      _confirmDialogCancel: function() {
        // Nothing
      },
    });
  </script>
</dom-module>
